#!/bin/bash
set -e

FATFS_FILE=ff10b.zip
FATFS_URL="http://elm-chan.org/fsw/ff/$FATFS_FILE"

SYSTEM_FILE=stm32-system.tar.bz2
SYSTEM_URL="https://dl.dropboxusercontent.com/u/56487493/$SYSTEM_FILE"

BASE_DIR=$(readlink -f `dirname "$0"`)
cd "$BASE_DIR"

mkdir -p dld lib

cd dld
if [ ! -e "$FATFS_FILE" ]; then
    wget "$FATFS_URL"
fi

if [ ! -e "$SYSTEM_FILE" ]; then
    wget "$SYSTEM_URL"
fi

cd ../lib

rm -rf fatfs
mkdir fatfs
cd fatfs
unzip -q "../../dld/$FATFS_FILE"
rm -- src/diskio.* src/ffconf.h
cp "../../dist/integer.h" src

cd "$BASE_DIR"

rm -rf system
pwd
tar xjf "dld/$SYSTEM_FILE"

echo Success
